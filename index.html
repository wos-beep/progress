<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æˆé•·è¨˜éŒ²ï¼ˆä¿®æ­£æ©Ÿèƒ½ä»˜ãï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f0f2f5; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h3 { margin-top: 0; border-left: 4px solid #007bff; padding-left: 10px; }
        textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .edit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 15px; background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .edit-item { display: flex; flex-direction: column; }
        .edit-item label { font-size: 12px; color: #666; margin-bottom: 4px; }
        .edit-item input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-group { margin-top: 15px; display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-parse { background: #6c757d; color: white; }
        .btn-save { background: #007bff; color: white; }
        .btn-clear { background: #dc3545; color: white; width: auto; flex: none; margin-top: 20px; }
        button:hover { opacity: 0.8; }
        .canvas-container { position: relative; height: 400px; width: 100%; }
    </style>
</head>
<body>

    <h2>ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æˆé•·æ¨ç§»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</h2>

    <div class="card">
        <h3>1. ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šè¾¼ã¿</h3>
        <div style="margin-bottom:15px;">
            æ—¥ä»˜: <input type="date" id="inputDate">
        </div>
        <textarea id="ocrInput" placeholder="Pixelã§ã‚³ãƒ”ãƒ¼ã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘"></textarea>
        <div class="btn-group">
            <button class="btn-parse" onclick="parseText()">æ•°å€¤ã‚’è§£æã—ã¦ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã¸</button>
        </div>

        <div id="editArea" style="display:none;">
            <h4 style="margin-bottom:5px;">å†…å®¹ã‚’ç¢ºèªãƒ»æ‰‹å‹•ä¿®æ­£ï¼š</h4>
            <div id="statsGrid" class="edit-grid"></div>
            <div class="btn-group">
                <button class="btn-save" onclick="saveToStorage()">ã“ã®å†…å®¹ã§ã‚°ãƒ©ãƒ•ã«ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>2. æˆé•·ã‚°ãƒ©ãƒ•</h3>
        <div class="canvas-container">
            <canvas id="growthChart"></canvas>
        </div>
    </div>

    <button class="btn-clear" onclick="clearData()">å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>

    <script>
        let myChart;
        const storageKey = 'game_stats_v2';
        // ã‚°ãƒ©ãƒ•ã«è¡¨ç¤ºã—ãŸã„å„ªå…ˆé …ç›®
        const displayTargets = ["ç›¾å…µæ”»æ’ƒåŠ›", "ç›¾å…µé˜²å¾¡åŠ›", "ç›¾å…µHP", "éƒ¨éšŠæ”»æ’ƒåŠ›", "éƒ¨éšŠé˜²å¾¡åŠ›"];

        window.onload = () => {
            document.getElementById('inputDate').valueAsDate = new Date();
            updateChart();
        };

        // --- 1. ãƒ†ã‚­ã‚¹ãƒˆè§£æãƒ­ã‚¸ãƒƒã‚¯ ---
        function parseText() {
            const text = document.getElementById('ocrInput').value;
            if (!text) return alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            // æ•°å€¤ï¼ˆ%, ã‚«ãƒ³ãƒå¯¾å¿œï¼‰ã¨æ—¥æœ¬èªé …ç›®åã‚’åˆ†é›¢ã—ã¦æŠ½å‡º
            const values = text.match(/[\d,.]+(?=%|)/g) || [];
            const labels = text.match(/[ä¸€-é¾ ã-ã‚“ã‚¡-ãƒ¶]{2,}/g) || [];

            const grid = document.getElementById('statsGrid');
            grid.innerHTML = '';
            
            // æŠ½å‡ºã•ã‚ŒãŸé …ç›®ã‚’ã™ã¹ã¦å…¥åŠ›æ¬„ï¼ˆinputï¼‰ã¨ã—ã¦ç”Ÿæˆ
            labels.forEach((label, i) => {
                if (values[i]) {
                    const val = values[i].replace(/,/g, '');
                    const item = document.createElement('div');
                    item.className = 'edit-item';
                    item.innerHTML = `
                        <label>${label}</label>
                        <input type="number" step="0.01" class="stat-input" data-label="${label}" value="${val}">
                    `;
                    grid.appendChild(item);
                }
            });

            document.getElementById('editArea').style.display = 'block';
        }

        // --- 2. ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ ---
        function saveToStorage() {
            const date = document.getElementById('inputDate').value;
            const inputs = document.querySelectorAll('.stat-input');
            const stats = {};

            inputs.forEach(input => {
                stats[input.dataset.label] = parseFloat(input.value);
            });

            const rawData = localStorage.getItem(storageKey);
            const history = rawData ? JSON.parse(rawData) : [];
            
            // åŒã˜æ—¥ä»˜ãŒã‚ã‚Œã°ä¸Šæ›¸ãã€ãªã‘ã‚Œã°è¿½åŠ 
            const existingIndex = history.findIndex(d => d.date === date);
            if (existingIndex > -1) {
                history[existingIndex] = { date, stats };
            } else {
                history.push({ date, stats });
            }

            history.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem(storageKey, JSON.stringify(history));
            
            alert("ä¿å­˜ã—ã¾ã—ãŸï¼ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ã—ã¾ã™ã€‚");
            document.getElementById('editArea').style.display = 'none';
            document.getElementById('ocrInput').value = '';
            updateChart();
        }

        // --- 3. ã‚°ãƒ©ãƒ•æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
        function updateChart() {
            const rawData = localStorage.getItem(storageKey);
            if (!rawData) return;
            const history = JSON.parse(rawData);

            const labels = history.map(d => d.date);
            const colors = ['#ff6384', '#36a2eb', '#4bc0c0', '#ff9f40', '#9966ff'];

            const datasets = displayTargets.map((target, i) => ({
                label: target,
                data: history.map(d => d.stats[target] || null),
                borderColor: colors[i % colors.length],
                backgroundColor: colors[i % colors.length] + '22',
                fill: false,
                tension: 0.2,
                spanGaps: true // ãƒ‡ãƒ¼ã‚¿ãŒæ¬ ã‘ã¦ã„ã¦ã‚‚ç·šã‚’ç¹‹ã
            }));

            const ctx = document.getElementById('growthChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { ticks: { callback: value => value + '%' } } }
                }
            });
        }

        function clearData() {
            if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem(storageKey);
                location.reload();
            }
        }
    </script>
</body>
</html>
