<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[v1.2.0] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æˆé•·è¨˜éŒ²ï¼ˆãƒ‡ãƒ¼ã‚¿çµ±åˆç‰ˆï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f0f2f5; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .header-flex { display: flex; justify-content: space-between; align-items: center; }
        .version-tag { font-size: 0.8em; color: #888; background: #eee; padding: 2px 8px; border-radius: 4px; }
        h3 { margin-top: 0; border-left: 4px solid #007bff; padding-left: 10px; }
        textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .edit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-top: 15px; background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .edit-item { display: flex; flex-direction: column; }
        .edit-item label { font-size: 11px; color: #666; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .edit-item input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-group { margin-top: 15px; display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-parse { background: #6c757d; color: white; }
        .btn-save { background: #28a745; color: white; }
        .btn-clear { background: #dc3545; color: white; width: auto; font-size: 12px; padding: 5px 10px; margin-top: 40px; }
        .canvas-container { position: relative; height: 400px; width: 100%; }
        .info-text { font-size: 12px; color: #0056b3; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="header-flex">
        <h2>ğŸ“ˆ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ¨ç§» <span class="version-tag">v1.2.0</span></h2>
    </div>

    <div class="card">
        <h3>1. ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šè¾¼ã¿</h3>
        <div style="margin-bottom:15px;">
            æ—¥ä»˜: <input type="date" id="inputDate">
            <div class="info-text">â€»åŒæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€Œä¸è¶³åˆ†ã‚’è¿½åŠ ãƒ»æ—¢å­˜åˆ†ã‚’æ›´æ–°ã€ã—ã¦çµ±åˆã•ã‚Œã¾ã™ã€‚</div>
        </div>
        <textarea id="ocrInput" placeholder="ã‚³ãƒ”ãƒš1å›ç›®ã‚’è²¼ã‚Šä»˜ã‘ -> ä¿å­˜ -> 2å›ç›®ã‚’è²¼ã‚Šä»˜ã‘ -> ä¿å­˜... ã§çµ±åˆã•ã‚Œã¾ã™"></textarea>
        <div class="btn-group">
            <button class="btn-parse" onclick="parseText()">æ•°å€¤ã‚’è§£æã—ã¦ç¢ºèª</button>
        </div>

        <div id="editArea" style="display:none; border-top: 1px dashed #ccc; margin-top: 20px; padding-top: 10px;">
            <p style="font-size:14px; color:#555;">è§£æã•ã‚ŒãŸé …ç›®ï¼š</p>
            <div id="statsGrid" class="edit-grid"></div>
            <div class="btn-group">
                <button class="btn-save" onclick="saveToStorage()">ã“ã®å†…å®¹ã‚’æœ¬æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã«çµ±åˆ</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>2. æˆé•·ã‚°ãƒ©ãƒ•</h3>
        <div class="canvas-container">
            <canvas id="growthChart"></canvas>
        </div>
    </div>

    <button class="btn-clear" onclick="clearData()">å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰</button>

    <script>
        let myChart;
        const storageKey = 'game_stats_v1.2.0';
        const displayTargets = ["éƒ¨éšŠæ”»æ’ƒåŠ›", "éƒ¨éšŠé˜²å¾¡åŠ›", "éƒ¨éšŠHP", "ç›¾å…µæ”»æ’ƒåŠ›", "ç›¾å…µé˜²å¾¡åŠ›", "ç›¾å…µHP", "æ§å…µæ”»æ’ƒåŠ›", "æ§å…µé˜²å¾¡åŠ›", "å¼“å…µæ”»æ’ƒåŠ›", "å¼“å…µé˜²å¾¡åŠ›", "å‡ºå¾é€Ÿåº¦ãƒœãƒ¼ãƒŠã‚¹"];

        window.onload = () => {
            document.getElementById('inputDate').valueAsDate = new Date();
            updateChart();
        };

        function parseText() {
            const text = document.getElementById('ocrInput').value;
            if (!text) return alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const values = text.match(/[\d,.]+(?=%|)/g) || [];
            const labels = text.match(/[ä¸€-é¾ ã-ã‚“ã‚¡-ãƒ¶ãƒ¼]{2,}/g) || [];

            const grid = document.getElementById('statsGrid');
            grid.innerHTML = '';
            
            labels.forEach((label, i) => {
                if (values[i]) {
                    const val = values[i].replace(/,/g, '');
                    const item = document.createElement('div');
                    item.className = 'edit-item';
                    item.innerHTML = `
                        <label title="${label}">${label}</label>
                        <input type="number" step="0.01" class="stat-input" data-label="${label}" value="${val}">
                    `;
                    grid.appendChild(item);
                }
            });

            document.getElementById('editArea').style.display = 'block';
        }

        // --- ä¿®æ­£ã®è¦ï¼šçµ±åˆãƒ­ã‚¸ãƒƒã‚¯ ---
        function saveToStorage() {
            const date = document.getElementById('inputDate').value;
            const inputs = document.querySelectorAll('.stat-input');
            const newStats = {};

            inputs.forEach(input => {
                newStats[input.dataset.label] = parseFloat(input.value);
            });

            const rawData = localStorage.getItem(storageKey);
            let history = rawData ? JSON.parse(rawData) : [];
            
            const existingIndex = history.findIndex(d => d.date === date);

            if (existingIndex > -1) {
                // ã€é‡è¦ã€‘æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ™ãƒ¼ã‚¹ã«æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸
                // Object.assign(å…ƒã®ãƒ‡ãƒ¼ã‚¿, æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿) ã§ã€æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒå„ªå…ˆã•ã‚Œã‚‹
                const mergedStats = Object.assign({}, history[existingIndex].stats, newStats);
                history[existingIndex].stats = mergedStats;
            } else {
                // ãã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒå…¨ããªã‘ã‚Œã°æ–°è¦è¿½åŠ 
                history.push({ date, stats: newStats });
            }

            history.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem(storageKey, JSON.stringify(history));
            
            alert("ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆä¿å­˜ã—ã¾ã—ãŸï¼");
            document.getElementById('editArea').style.display = 'none';
            document.getElementById('ocrInput').value = '';
            updateChart();
        }

        function updateChart() {
            const rawData = localStorage.getItem(storageKey);
            if (!rawData) return;
            const history = JSON.parse(rawData);

            const labels = history.map(d => d.date);
            const colors = ['#ff6384', '#36a2eb', '#4bc0c0', '#ff9f40', '#9966ff', '#f1c40f', '#e67e22', '#1abc9c', '#34495e', '#9b59b6'];

            const datasets = displayTargets.map((target, i) => ({
                label: target,
                data: history.map(d => (d.stats && d.stats[target] !== undefined) ? d.stats[target] : null),
                borderColor: colors[i % colors.length],
                backgroundColor: colors[i % colors.length] + '22',
                fill: false,
                tension: 0.2,
                spanGaps: true
            }));

            const ctx = document.getElementById('growthChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } },
                    scales: { y: { ticks: { callback: value => value + '%' } } }
                }
            });
        }

        function clearData() {
            if(confirm("å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem(storageKey);
                location.reload();
            }
        }
    </script>
</body>
</html>
