<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[v1.3.0] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æˆé•·è¨˜éŒ²ï¼ˆå…¥å‡ºåŠ›æ©Ÿèƒ½ä»˜ãï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f0f2f5; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .header-flex { display: flex; justify-content: space-between; align-items: center; }
        .version-tag { font-size: 0.8em; color: #888; background: #eee; padding: 2px 8px; border-radius: 4px; }
        h3 { margin-top: 0; border-left: 4px solid #007bff; padding-left: 10px; }
        textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .edit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-top: 15px; background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .edit-item { display: flex; flex-direction: column; }
        .edit-item label { font-size: 11px; color: #666; margin-bottom: 2px; }
        .edit-item input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-group { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        button { flex: 1; min-width: 120px; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-parse { background: #6c757d; color: white; }
        .btn-save { background: #28a745; color: white; }
        .btn-export { background: #17a2b8; color: white; }
        .btn-import { background: #ffc107; color: #333; }
        .btn-clear { background: #dc3545; color: white; width: auto; font-size: 12px; padding: 5px 10px; margin-top: 40px; }
        .canvas-container { position: relative; height: 400px; width: 100%; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="header-flex">
        <h2>ğŸ“ˆ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ¨ç§» <span class="version-tag">v1.3.0</span></h2>
        <div>
            <button class="btn-export" style="padding: 8px; font-size: 12px;" onclick="exportData()">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <button class="btn-import" style="padding: 8px; font-size: 12px;" onclick="document.getElementById('fileInput').click()">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            <input type="file" id="fileInput" accept=".json" onchange="importData(event)">
        </div>
    </div>

    <div class="card">
        <h3>1. ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šè¾¼ã¿</h3>
        <div style="margin-bottom:15px;">
            æ—¥ä»˜: <input type="date" id="inputDate">
        </div>
        <textarea id="ocrInput" placeholder="Pixelã®ã‚³ãƒ”ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘"></textarea>
        <div class="btn-group">
            <button class="btn-parse" onclick="parseText()">æ•°å€¤ã‚’è§£æã—ã¦ç¢ºèª</button>
        </div>

        <div id="editArea" style="display:none; border-top: 1px dashed #ccc; margin-top: 20px; padding-top: 10px;">
            <div id="statsGrid" class="edit-grid"></div>
            <div class="btn-group">
                <button class="btn-save" onclick="saveToStorage()">ã“ã®å†…å®¹ã‚’æœ¬æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã«çµ±åˆ</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>2. æˆé•·ã‚°ãƒ©ãƒ•</h3>
        <div class="canvas-container">
            <canvas id="growthChart"></canvas>
        </div>
    </div>

    <button class="btn-clear" onclick="clearData()">å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»</button>

    <script>
        let myChart;
        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ã¯ãƒ‡ãƒ¼ã‚¿äº’æ›æ€§ã®ãŸã‚ã«å›ºå®šï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤‰ã‚ã£ã¦ã‚‚å¼•ãç¶™ã’ã‚‹ã‚ˆã†ã«ï¼‰
        const storageKey = 'game_stats_v1.2.0'; 
        const displayTargets = ["éƒ¨éšŠæ”»æ’ƒåŠ›", "éƒ¨éšŠé˜²å¾¡åŠ›", "éƒ¨éšŠHP", "ç›¾å…µæ”»æ’ƒåŠ›", "ç›¾å…µé˜²å¾¡åŠ›", "ç›¾å…µHP", "æ§å…µæ”»æ’ƒåŠ›", "æ§å…µé˜²å¾¡åŠ›", "å¼“å…µæ”»æ’ƒåŠ›", "å¼“å…µé˜²å¾¡åŠ›", "å‡ºå¾é€Ÿåº¦ãƒœãƒ¼ãƒŠã‚¹"];

        window.onload = () => {
            document.getElementById('inputDate').valueAsDate = new Date();
            updateChart();
        };

        function parseText() {
            const text = document.getElementById('ocrInput').value;
            if (!text) return;

            const values = text.match(/[\d,.]+(?=%|)/g) || [];
            // è‹±å­—ã‚‚å«ã‚ã¦æŠ½å‡ºã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ï¼ˆç›¾å…µHPå¯¾ç­–ï¼‰
            const labels = text.match(/[ä¸€-é¾ ã-ã‚“ã‚¡-ãƒ¶ãƒ¼A-Za-z]{2,}/g) || [];

            const grid = document.getElementById('statsGrid');
            grid.innerHTML = '';
            
            labels.forEach((label, i) => {
                if (values[i]) {
                    const val = values[i].replace(/,/g, '');
                    const item = document.createElement('div');
                    item.className = 'edit-item';
                    item.innerHTML = `
                        <label>${label}</label>
                        <input type="number" step="0.01" class="stat-input" data-label="${label}" value="${val}">
                    `;
                    grid.appendChild(item);
                }
            });
            document.getElementById('editArea').style.display = 'block';
        }

        function saveToStorage() {
            const date = document.getElementById('inputDate').value;
            const inputs = document.querySelectorAll('.stat-input');
            const newStats = {};
            inputs.forEach(input => { newStats[input.dataset.label] = parseFloat(input.value); });

            const rawData = localStorage.getItem(storageKey);
            let history = rawData ? JSON.parse(rawData) : [];
            const existingIndex = history.findIndex(d => d.date === date);

            if (existingIndex > -1) {
                history[existingIndex].stats = Object.assign({}, history[existingIndex].stats, newStats);
            } else {
                history.push({ date, stats: newStats });
            }

            history.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem(storageKey, JSON.stringify(history));
            alert("çµ±åˆä¿å­˜ã—ã¾ã—ãŸã€‚");
            document.getElementById('editArea').style.display = 'none';
            document.getElementById('ocrInput').value = '';
            updateChart();
        }

        // --- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ---
        function exportData() {
            const data = localStorage.getItem(storageKey);
            if (!data) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `game_stats_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // --- ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ---
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if (confirm("æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«ä¸Šæ›¸ãã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                        localStorage.setItem(storageKey, JSON.stringify(json));
                        location.reload();
                    }
                } catch (err) {
                    alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
                }
            };
            reader.readAsText(file);
        }

        function updateChart() {
            const rawData = localStorage.getItem(storageKey);
            if (!rawData) return;
            const history = JSON.parse(rawData);
            const labels = history.map(d => d.date);
            const colors = ['#ff6384', '#36a2eb', '#4bc0c0', '#ff9f40', '#9966ff', '#f1c40f', '#e67e22', '#1abc9c', '#34495e', '#9b59b6'];

            const datasets = displayTargets.map((target, i) => ({
                label: target,
                data: history.map(d => (d.stats && d.stats[target] !== undefined) ? d.stats[target] : null),
                borderColor: colors[i % colors.length],
                backgroundColor: colors[i % colors.length] + '22',
                fill: false,
                tension: 0.2,
                spanGaps: true
            }));

            const ctx = document.getElementById('growthChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } },
                    scales: { y: { ticks: { callback: v => v + '%' } } }
                }
            });
        }

        function clearData() {
            if(confirm("å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem(storageKey);
                location.reload();
            }
        }
    </script>
</body>
</html>
