<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[v1.6.0] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æˆé•·è¨˜éŒ² - ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ä»˜</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --accent: #03dac6; --border: #333; }
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: var(--bg-color); color: var(--text-color); }
        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        .header-flex { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 10px; }
        .version-tag { font-size: 0.7em; color: #888; background: #333; padding: 2px 8px; border-radius: 4px; }
        h3 { margin-top: 0; color: var(--accent); border-left: 4px solid var(--accent); padding-left: 10px; font-size: 16px; }
        textarea { width: 100%; height: 80px; padding: 10px; background: #2c2c2c; color: #fff; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px; }
        button { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .btn-main { background: var(--accent); color: #000; flex: 1; }
        .btn-filter { background: #444; color: #fff; flex: none; }
        .btn-filter.active { background: var(--accent); color: #000; }
        .edit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; background: #252525; padding: 10px; border-radius: 8px; margin-top: 10px; }
        .canvas-container { position: relative; height: 500px; width: 100%; }
        input[type="number"] { padding: 5px; background: #2c2c2c; color: #fff; border: 1px solid #444; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="header-flex">
        <h2>ğŸ“ˆ Status Tracker <span class="version-tag">v1.6.0</span></h2>
        <div>
            <button onclick="exportData()" style="font-size:10px; background:#444; color:#fff;">Export</button>
            <button onclick="document.getElementById('fileInput').click()" style="font-size:10px; background:#444; color:#fff;">Import</button>
            <input type="file" id="fileInput" accept=".json" onchange="importData(event)">
        </div>
    </div>

    <div class="card">
        <h3>1. ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šè¾¼ã¿</h3>
        <input type="date" id="inputDate" style="margin-bottom:10px; padding:8px;">
        <textarea id="ocrInput" placeholder="ã‚³ãƒ”ãƒ¼ã—ãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
        <button class="btn-main" style="width:100%; margin-top:10px;" onclick="parseText()">æ•°å€¤ã‚’æŠ½å‡ºã—ã¦ç¢ºèª</button>
        <div id="editArea" style="display:none; border-top: 1px solid #333; margin-top: 15px; padding-top: 10px;">
            <div id="statsGrid" class="edit-grid"></div>
            <button class="btn-main" style="width:100%; margin-top:10px;" onclick="saveToStorage()">ã“ã®å†…å®¹ã§çµ±åˆä¿å­˜</button>
        </div>
    </div>

    <div class="card">
        <h3>2. æˆé•·æ¨ç§»ï¼ˆå·¦å³2è»¸ï¼‰</h3>
        <div class="btn-group" id="filterGroup">
            <button class="btn-filter" onclick="filterChart('éƒ¨éšŠ')">éƒ¨éšŠ</button>
            <button class="btn-filter" onclick="filterChart('ç›¾å…µ')">ç›¾å…µ</button>
            <button class="btn-filter" onclick="filterChart('æ§å…µ')">æ§å…µ</button>
            <button class="btn-filter" onclick="filterChart('å¼“å…µ')">å¼“å…µ</button>
            <button class="btn-filter" onclick="filterChart('çƒˆæ—¥|åˆ‡ã‚Šæœ­')">å…µå£«æ•°</button>
            <button class="btn-filter" onclick="filterChart('all')" style="background:#666;">å…¨è¡¨ç¤º</button>
            <button class="btn-filter" onclick="filterChart('none')" style="background:#666;">å…¨æ¶ˆã—</button>
        </div>
        <div class="canvas-container">
            <canvas id="growthChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>3. å±¥æ­´ç®¡ç†</h3>
        <div id="historyList"></div>
    </div>

    <script>
        let myChart;
        const storageKey = 'game_stats_v1.2.0'; 
        const soldierKeywords = ["çƒˆæ—¥", "åˆ‡ã‚Šæœ­"];
        const percentStats = ["éƒ¨éšŠæ”»æ’ƒåŠ›", "éƒ¨éšŠé˜²å¾¡åŠ›", "éƒ¨éšŠHP", "ç›¾å…µæ”»æ’ƒåŠ›", "ç›¾å…µé˜²å¾¡åŠ›", "ç›¾å…µHP", "æ§å…µæ”»æ’ƒåŠ›", "æ§å…µé˜²å¾¡åŠ›", "æ§å…µHP", "å¼“å…µæ”»æ’ƒåŠ›", "å¼“å…µé˜²å¾¡åŠ›", "å¼“å…µHP", "å‡ºå¾é€Ÿåº¦ãƒœãƒ¼ãƒŠã‚¹"];
        const soldierStats = ["çƒˆæ—¥ç›¾å…µ", "çƒˆæ—¥æ§å…µ", "çƒˆæ—¥å¼“å…µ", "åˆ‡ã‚Šæœ­ç›¾å…µ", "åˆ‡ã‚Šæœ­æ§å…µ", "åˆ‡ã‚Šæœ­å¼“å…µ"];
        const displayTargets = [...percentStats, ...soldierStats];

        window.onload = () => {
            document.getElementById('inputDate').valueAsDate = new Date();
            updateChart();
            renderHistory();
        };

        function parseText() {
            const text = document.getElementById('ocrInput').value;
            if (!text) return;
            const values = text.match(/[\d,.]+/g) || [];
            const labels = text.match(/[ä¸€-é¾ ã-ã‚“ã‚¡-ãƒ¶ãƒ¼A-Za-z]{2,}/g) || [];
            const grid = document.getElementById('statsGrid');
            grid.innerHTML = '';
            labels.forEach((label, i) => {
                if (values[i]) {
                    const val = values[i].replace(/,/g, '');
                    grid.innerHTML += `<div class="edit-item"><label style="font-size:9px; color:#aaa;">${label}</label><input type="number" step="0.01" class="stat-input" data-label="${label}" value="${val}"></div>`;
                }
            });
            document.getElementById('editArea').style.display = 'block';
        }

        function saveToStorage() {
            const date = document.getElementById('inputDate').value;
            const inputs = document.querySelectorAll('.stat-input');
            const newStats = {};
            inputs.forEach(input => { newStats[input.dataset.label] = parseFloat(input.value); });
            const rawData = localStorage.getItem(storageKey);
            let history = rawData ? JSON.parse(rawData) : [];
            const idx = history.findIndex(d => d.date === date);
            if (idx > -1) { history[idx].stats = Object.assign({}, history[idx].stats, newStats); }
            else { history.push({ date, stats: newStats }); }
            history.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem(storageKey, JSON.stringify(history));
            document.getElementById('editArea').style.display = 'none';
            document.getElementById('ocrInput').value = '';
            updateChart();
            renderHistory();
        }

        function updateChart() {
            const rawData = localStorage.getItem(storageKey);
            if (!rawData) return;
            const history = JSON.parse(rawData);
            const labels = history.map(d => d.date);
            const colors = ['#03dac6', '#bb86fc', '#ff0266', '#ffde03', '#03a9f4', '#4caf50', '#ff9800', '#f44336', '#9c27b0', '#795548', '#607d8b', '#e91e63', '#1abc9c', '#2ecc71', '#3498db', '#9b59b6', '#aed581', '#ff8a65', '#d4e157', '#4db6ac'];

            const datasets = displayTargets.map((target, i) => {
                const isSoldier = soldierStats.includes(target) || soldierKeywords.some(k => target.includes(k));
                return {
                    label: target,
                    data: history.map(d => (d.stats && d.stats[target] !== undefined) ? d.stats[target] : null),
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length],
                    yAxisID: isSoldier ? 'y1' : 'y',
                    tension: 0.2,
                    spanGaps: true,
                    hidden: false // æœ€åˆã¯å…¨è¡¨ç¤º
                };
            });

            const ctx = document.getElementById('growthChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { color: '#aaa', font: { size: 9 }, boxWidth: 10 } }
                    },
                    scales: { 
                        x: { ticks: { color: '#aaa' }, grid: { color: '#333' } },
                        y: { position: 'left', ticks: { color: '#03dac6', callback: v => v + '%' }, title: { display: true, text: '%', color: '#03dac6' } },
                        y1: { position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#bb86fc' }, title: { display: true, text: 'å®Ÿæ•°', color: '#bb86fc' } }
                    }
                }
            });
        }

        // --- ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ ---
        function filterChart(category) {
            myChart.data.datasets.forEach(ds => {
                if (category === 'all') {
                    ds.hidden = false;
                } else if (category === 'none') {
                    ds.hidden = true;
                } else {
                    const regex = new RegExp(category);
                    ds.hidden = !regex.test(ds.label);
                }
            });
            myChart.update();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem(storageKey) || "[]");
            let html = `<table style="width:100%; font-size:12px;">`;
            history.forEach((entry, i) => {
                html += `<tr style="border-bottom:1px solid #333;"><td style="padding:8px;">${entry.date}</td><td style="text-align:right;"><button onclick="editHistory(${i})" style="background:#03a9f4; padding:3px 7px; font-size:10px;">ä¿®æ­£</button></td></tr>`;
            });
            document.getElementById('historyList').innerHTML = html + `</table>`;
        }

        function editHistory(index) {
            const entry = JSON.parse(localStorage.getItem(storageKey))[index];
            document.getElementById('inputDate').value = entry.date;
            const grid = document.getElementById('statsGrid');
            grid.innerHTML = '';
            for (let label in entry.stats) {
                grid.innerHTML += `<div class="edit-item"><label style="font-size:9px;">${label}</label><input type="number" step="0.01" class="stat-input" data-label="${label}" value="${entry.stats[label]}"></div>`;
            }
            document.getElementById('editArea').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function exportData() {
            const data = localStorage.getItem(storageKey);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([data], { type: 'application/json' }));
            a.download = `status_tracker_v160.json`;
            a.click();
        }

        function importData(e) {
            const r = new FileReader();
            r.onload = (ev) => { localStorage.setItem(storageKey, ev.target.result); location.reload(); };
            r.readAsText(e.target.files[0]);
        }
    </script>
</body>
</html>
